@using System.Web.Optimization
@using VocaDb.Web.Helpers
@inherits VocaDb.Web.Code.VocaDbPage

@{
	ViewBag.Title = "Discussions";
}

<link rel="stylesheet" href="@Url.Content("~/Content/Styles/discussions.css")" />

<ul class="breadcrumb" data-bind="visible: selectedFolder()">
	<li>
		<a href="#" data-bind="click: function() { selectedTopic(null); selectedFolder(null); }">Discussions</a>
		<span data-bind="visible: selectedTopic()" class="divider">/</span>
	</li>
	<li>
		<a href="#" data-bind="visible: selectedTopic(), click: function() { selectedTopic(null); }, text: selectedFolder() != null ? selectedFolder().name : ''"></a>
	</li>
</ul>

<table class="table" data-bind="visible: selectedFolder() === null">
	<thead>
		<tr>
			<th>Folder</th>
			<th>Topics</th>
			<th>Last topic</th>
		</tr>
	</thead>
	<tbody data-bind="foreach: folders" class="discussion-folders">
		<tr data-bind="css: { active: $data == $parent.selectedFolder() }, click: function() { $parent.selectedFolder($data); }">
			<td>
				<span data-bind="text: name" class="discussion-folder-name"></span>
				<span class="discussion-folder-description" data-bind="text: description"></span>
			</td>
			<td>
				<span data-bind="text: topicCount"></span>
			</td>
			<td>
				<span data-bind="text: $data.lastTopicDate"></span>
			</td>
		</tr>
	</tbody>
</table>

<ul data-bind="foreach: folders, visible: selectedFolder() !== null && selectedTopic() === null" class="nav nav-pills">
	<li data-bind="css: { active: $data == $parent.selectedFolder() }">
		<a href="#" data-bind="click: function() { $parent.selectedFolder($data); }, text: name, attr: { title: description }">
		</a>
	</li>
</ul>

<table class="table" data-bind="visible: selectedFolder() !== null && selectedTopic() === null">
	<thead>
		<tr>
			<th>Topic</th>
			<th>Author</th>
			<th>Comments</th>
			<th>Last comment</th>
		</tr>
	</thead>
	<tbody data-bind="foreach: topics" class="discussion-topics">
		<tr data-bind="css: { active: $data == $parent.selectedTopic() }, click: function() { $parent.selectedTopic($data); }">
			<td>
				<span data-bind="text: name"></span>
			</td>
			<td>
				<a data-bind="attr: { href: '/User/Profile/' + author.name }">
					@UserHelpers.ProfileIconKnockout("author.iconUrl", 18)
					<span data-bind="text: author.name"></span>
				</a>				
			</td>
			<td>
				<span data-bind="text: commentCount"></span>
			</td>
			<td>
				<span data-bind="text: $data.lastCommentDate"></span>
			</td>
		</tr>
	</tbody>
</table>

<div data-bind="with: selectedTopic()">
	
	<h3 data-bind="text: name"></h3>
	@CommentHelpers.CommentBodyKnockout("content", true)
	
	<div data-bind="foreach: comments">
		@CommentHelpers.CommentBodyKnockout("message", false)
	</div>
</div>

@section BodyScripts {
	@Scripts.Render("~/bundles/Discussion/Index")
	<script type="text/javascript">

		$(function () {
			var repoFactory = new vdb.repositories.RepositoryFactory(new vdb.UrlMapper('@RootPath'), @LanguagePreferenceInt);
			var repo = repoFactory.discussionRepository();
			ko.applyBindings(new vdb.viewModels.discussions.DiscussionIndexViewModel(repo));
		});

	</script>
}
